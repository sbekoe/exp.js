(function(t,e){if("object"==typeof exports){var n=require("underscore");module.exports=e(n)}else if("function"==typeof define&&define.amd)define(["underscore"],e);else{var i=t._;t.Exp=e(i)}})(this,function(_){"use strict";var escNativeExp=RegExp("[\\-\\[\\]\\/\\{\\}\\(\\)\\*\\+\\?\\.\\\\\\^\\$\\|]","g"),escAdvancedExp=RegExp("[\\-\\[\\]\\/\\{\\}\\(\\)\\*\\+\\?\\.\\\\\\^\\$\\|%#]","g"),esc=function(t,e){return _.isArray(t)&&(t=t.join("")),t.replace(e?escNativeExp:escAdvancedExp,"\\$&")},resolvePath=function(path,obj,delimitter){if(delimitter=delimitter||".",obj=obj||window,obj[path])return obj[path];path=(path+"").split(delimitter);try{return eval('(obj["'+path.join('"]["')+'"])')}catch(e){return void 0}},INJECTION_PREFIX="%",CAPTURE_PREFIX="#",ASSIGNMENT_PREFIX=">",PATH_DELIMITER=".",DELIMITER_ESC=esc(PATH_DELIMITER,!0),PATH="\\w+(?:"+DELIMITER_ESC+"(?:\\w+|\\[\\d+\\]))*",DEEP_PATH="\\w+(?:"+DELIMITER_ESC+"(?:\\w+|\\[\\d+\\]))+",ASSIGNMENT_EXP=RegExp("(^"+ASSIGNMENT_PREFIX+"{1,2})("+PATH+")"),REPETITION_EXP=/^[*+]|^\{(\d+)(,?)(\d*)(?:,([^\}]+))?\}/,MARKER=RegExp("\\$("+PATH+"|[\\d&])","g"),DEBUG_MODE=!0,SPLITTER=/,|\s+/,PARENTHESIS=/(\\\(|\(\?[:=!])|\((?:#\w+:)?/g,BREAK={},SKIP={},Collection=function(t){var e=function(t){this._wrapped=t||[]};return e.prototype=t([]),e.prototype.bind=function(e,n){var i=this._parent,s=this;return s[e]=t.isFunction(i[e])?function(){var t=arguments;return this.map(function(s){return i[e].apply(n||s,t)})}:t.isFunction(t[e])?function(){var i=arguments;return this.map(function(s){return t[e].apply(n||s,[s].concat(i))})}:function(){var i=arguments;return this.map(function(s){return t.isFunction(s[e])?s[e].apply(n||s,i):s[e]})},s[e]},e.prototype.add=function(e){this.push(t.isFunction(this._parent)?this._parent.apply(null,arguments):e)},e.extend=function(n,i){var s=i||{},r=s.fn||{},a=s.context,c=n.prototype||n,o=i.bind||t.functions(n),u=s.constructor||function(){},h=function(){e.apply(this,arguments),u.apply(this,arguments)},p=t.extend(new e,r);return t.extend(h,s),p._parent=c,t.each(o,function(t){p.bind(t,a)}),h.prototype=p,h},e}(_),Exp=function(){var t=function(e,n){return e instanceof t?e:this instanceof t?(this.initialize(e,n),void 0):new t(e,n)};t.prototype={initialize:function(t,e){var n=e||t||{};this.source=t.source?""+t.source:t,this.global=t.global||n.global,this.ignoreCase=t.ignoreCase||n.ignoreCase,this.multiline=t.multiline||n.multiline,this.options=_.extend({},s,e,t),_.extend(this,_.pick(this.options,r)),this.flags=n.flags||"",this.wildcards=n.wildcards||{},this.assignments=n.assignments||{},this.zero(n.lastIndex),this.compile(n)},zero:function(t){return this.lastIndex=t||0,this.lastRange=[0,t||0],this.lastMatch=null,this},compile:function(t){var e,n=[],i=[],s=[],r=["\\(","\\)",CAPTURE_PREFIX,INJECTION_PREFIX],a=this.wildcards,c=t||{};for(e in a)a.hasOwnProperty(e)&&(e[0]===CAPTURE_PREFIX&&(e=e.slice(1),s.push(e),r.push(e)),e[0]===INJECTION_PREFIX&&(e=e.slice(1),i.push(e),r.push(e)),n.push(e));this._captures=c.captures||[{path:"",name:""}],this.indices=c.indices||{path:{},name:{},list:{}},this.offset=c.offset||0,this._escaped=r,this._needle=RegExp("\\\\("+r.join("|")+")|"+"\\(("+CAPTURE_PREFIX+"|"+INJECTION_PREFIX+")(\\w+(?:,\\w+)*):|"+"(\\((?!\\?:))|"+"("+CAPTURE_PREFIX+"|"+INJECTION_PREFIX+")("+(n.sort(u).join("|")||"$^")+")|"+"("+(s.join("|")||"$^")+")|"+"("+(i.join("|")||"$^")+")","g");var o=this._captures.length>1?this.source:this.build(this.source,this._captures),h=this.flags||(this.global?"g":"")+(this.ignoreCase?"i":"")+(this.multiline?"m":"");this._exp=RegExp(o,h)},build:function(e,n,i){var s,r,a,c,o,u,h,l,f,d,g,E,x=_.isArray(e)?e:[e],I=this.wildcards,m=this._needle,v=this._escaped,R=this.indices.name,P=this.indices.path,T=this.indices.list,A=i||[],y="",b=m.lastIndex=0;for(h=0;x.length>h;h++){if(l=x[h].hasOwnProperty("s")?x[h].s:x[h].hasOwnProperty("srcArr")?x[h].source:x[h],!l)return"";for(h>0&&(y+="|");c=m.exec(l);)if(o=I[c[6]]||I[CAPTURE_PREFIX+c[7]]||I[INJECTION_PREFIX+c[8]]||(c[2]||c[4]?{s:p(l.slice(m.lastIndex)),a:x[h].a||x[h].assign}:!1)){if(r=c[2]===CAPTURE_PREFIX||c[4]||c[5]===CAPTURE_PREFIX||c[7]!==void 0,s=(c[3]||c[6]||c[7]||c[8]||"").split(","),-1===A.indexOf(s[0])?A.push(s[0]):this.error('"'+s[0]+'" includes itself. This would end up in infinity recursion loop!'),r&&(g=n.push(a={name:s[0],path:A.join(PATH_DELIMITER),aliases:_.rest(s)}),E=y.length,_.each(s,function(t){(R[t]||(R[t]=[])).push(g-1)}),Object(P[a.path]||(P[a.path]=[])).push(g-1)),u=this.build(o.s||o.source||o,n,A),y+=l.slice(b,c.index),b=c.index+c[0].length+(c[2]||c[4]?o.s.length+1:0),r&&(d=l.slice(b).match(ASSIGNMENT_EXP))&&(b+=d[0].length,a.a={force:2===d[1].length,path:d[2]}),r&&this.options.enableLists&&(f=REPETITION_EXP.exec(l.slice(b)))){var C=0,M=1,S=2,w=3,N=4;if(a.r={capBound:[g,n.length],expBound:[E+4,E+u.length+4]},(T[a.path]||(T[a.path]=[])).push(g-1),f[N]){var O=t.parse(PARENTHESIS,u,function(t){return t[1]||"(?:"}).join("");u="(?:"+u+")"+("0"!==f[M]?"":f[S]?"?":"{0}")+"(?:"+f[N]+"(?:"+O+")"+"){"+("0"===f[M]?0:f[M]-1)+f[S]+(f[w]?"0"===f[w]?0:f[w]-1:"")+"}"}else u="(?:"+u+")"+f[C];b+=f[C].length}y+=(r?"(":"(?:")+u+")",m.lastIndex=b,A.pop()}y+=l.slice(b)}return y.replace(RegExp("\\\\("+v.join("|")+")","g"),"$1")},exec:function(t){var e,n;return this._exp.lastIndex=this.lastIndex,(e=this._exp.exec(t))&&(this.lastIndex=this._exp.lastIndex,this.lastMatch=n=new Match(e,this),this.lastRange=n.range),n||null},test:function(t){return this._exp.test(t)},expand:function(t){return this.build(t,[],{})},error:function(t){if(DEBUG_MODE===!0)throw"Error in Expression /"+this.source+"/: "+t},subExp:function(e){var n=e-this.offset,i=this._captures[n];if(void 0!==i.r)return i.e||(i.e=new t({source:a.apply(this._exp.source,i.r.expBound),captures:[{}].concat(c.apply(this._captures,i.r.capBound)),indices:this.indices,assignments:this.assignments,offset:i.r.capBound[0]-1,global:!0})),this._captures[n].e},SKIP:SKIP,BREAK:BREAK};var e=t.scan=function(t,e,n){var i,s,r=[],a=h(n);for(_.isFunction(t.zero)?t.zero():t.lastIndex=0;(s=t.exec(e))&&(i=a.call(t,s,r),i!==BREAK)&&(i!==SKIP&&r.push(i),t.global););return _.extend(new Match.Collection(r),r,{length:r.length})},n=(t.search=function(t,n,i){var s,r=h(i);return e(t,n,function(){return s=r.apply(this,arguments),s!==SKIP?BREAK:s}),s||null},t.parse=function(t,n,s){var r,a=0,c=0,o=0,u=h(s),p=/\n/g,l=e(t,n,function(e,s){return r=n.slice(a,e.index),c+=i(p,r),e.i=++o,e.line=c,e.index!==a&&s.push(r),c+=i(p,e[0]||""),a=e.index+e[0].length,u.call(t,e,s)});return n.length>a&&l.push(l[l.length]=n.slice(a)),l}),i=(t.replace=function(){return n.apply(this,arguments).join("")},t.count=function(){return e.apply(this,arguments).length});t.esc=esc,_.each(["scan","search","parse","replace","count"],function(e){t.prototype[e]=function(){var n=[this];return o.apply(n,arguments),t[e].apply(this,n)}});var s={enableLists:!0,global:!1,ignoreCase:!1,multiline:!1},r=["source"],a=String.prototype.slice,c=Array.prototype.slice,o=Array.prototype.push,u=function(t,e){return e.length-t.length},h=t.getMapper=function(t){var e,i={};return"string"!=typeof t?t||_.identity:(e=n(MARKER,t,function(t,e){i[e.length]=t[1]}).value(),function(t){for(var n in i)e[n]="&"===i[n]?t[0]:t.get?t.get(i[n]):t[i[n]];return e.join("")})},p=function(e){var n=1;return t.search(/\(|\)|\\\(|\\\)/g,e,function(t){return"("===t[0]&&n++,")"===t[0]&&n--,0===n?e.slice(0,t.index):SKIP})};return t}(),Match=function(t){var e=function(e){var n=e.split(SPLITTER),i=this._exp,s=this,r=t.chain(i.indices.list).map(function(e,r){return t.chain(n).map(function(t){var n,a=t.indexOf(r);return n=0===a?t.slice(a+r.length+1):t,!n||0!==a&&-1!==t.indexOf(PATH_DELIMITER)||!i.subExp(e)?!1:s.getSubMatches(e).map(function(t){return t.cap([n])})}).compact().value()}).flatten().value();return t.chain(t.values(t.pick(i.indices.path,n))).concat(t.values(t.pick(i.indices.name,n))).flatten().union().map(function(t){return this.isList(t)?this.getSubMatches(t):this.getCapture(t)},this).concat(r).compact().union().value()},n=Exp.Match=function(i,s){return i instanceof n?n:this instanceof n?(this._wrapped=this._match=i,this._exp=s,this._getCaptures=t.memoize(e),this._subMatch={},t.extend(this,i),this.match=i[0],this.length=i.length,this.lastRange=s.lastRange,this.range=[i.index,s.lastIndex],this["&"]=i[0],this["`"]=this.input.slice(0,this.index),this["'"]=this.input.slice(s.lastIndex),void 0):new n(i,s)},i=function(t,e){return t._chain?(t._wrapped=e,t):e},s=n.prototype=t([]);return s.cap=s.capture=function(e){var n=t.isArray(e),s=this._getCaptures(n?e.join(","):e);return i(this,n?s:s[0])},s.atm=s.attachment=function(t){var e=this.getAssignments();return t?resolvePath(t,e):e},s.assignment=s.atm,s.get=function(t){var e;return void 0!==(e=this.capture(t))?e:void 0!==(e=this.assignment(t))?e:void 0!==(e="$"===t[0]?this[t.slice(1)]:this[t])?e:this[t]},s.toString=function(){return this._match[0]},s.getAssignments=function(){return this._assignments||(this._assignments=t.reduce(this._match,function(t,e,n){var i,s,r=this._exp._captures[n];if(void 0===e||!r.a)return t;i=resolvePath(r.a.path,this._exp.assignments),i=i[e]||i;for(s in i)(r.a.force||void 0===t[s])&&(t[s]=i[s]);return t},{},this)),i(this,this._assignments)},s.getOffset=function(t){return t-this._exp.offset},s.getSubMatches=function(t){return this._subMatch[t]||(this._subMatch[t]=this._exp.subExp(t).scan(this._match[this.getOffset(t)]))},s.getCapture=function(t){return this._match[this.getOffset(t)]},s.isList=function(t){return!!this._exp._captures[this.getOffset(t)].r},s.$="$",n.Collection=Collection.extend(n,{bind:["get","cap","capture","atm","attachment","assignment","getAssignments"]}),n}(_);return Exp.VERSION="0.2.1",Exp.Collection=Collection,Exp.Match=Match,Exp});
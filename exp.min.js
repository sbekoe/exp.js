/*! exp.js - v0.0.0 - 2013-01-27
 * https://github.com/sbekoe/exp.js
 * Copyright (c) 2013 Simon Bekoe; Licensed MIT */
(function(e,t){if(typeof exports=="object"){var n=require("underscore");module.exports=t(n)}else if(typeof define=="function"&&define.amd)define(["jquery","underscore","backbone","backbone.wreqr","backbone.babysitter"],t);else{var r=e._;e.Exp=t(r)}})(this,function(_){"use strict";var INJECTION_PREFIX="%",CAPTURE_PREFIX="#",ASSIGNMENT_PREFIX=">",PATH="\\w+(?:\\.(?:\\w+|\\[\\d+\\]))*",ASSIGNMENT_EXP=new RegExp("("+ASSIGNMENT_PREFIX+"{1,2})("+PATH+")","g"),REPETITION_EXP=/^[*+]|^\{(\d+)(,?)(\d*)(?:,([^\}]+))?\}/,MARKER=new RegExp("\\$("+PATH+"|[\\d&])","g"),PATH_DELIMITER=".",DEBUG_MODE=!0,SPLITTER=/,|\s+/,PARENTHESIS=/(\\\(|\(\?[:=!])|\((?:#\w+:)?/g,defaults={captureRepetition:!1,global:!1,ignoreCase:!1,multiline:!1},specialOpt=["source"],Exp=function(e,t){if(e instanceof Exp)return e;if(!(this instanceof Exp))return new Exp(e,t);this.initialize(e,t)};Exp.VERSION="0.0.0",Exp.prototype={initialize:function(e,t){var n=t||e||{};this.source=e.source?e.source.toString():e,this.global=e.global||n.global,this.ignoreCase=e.ignoreCase||n.ignoreCase,this.multiline=e.multiline||n.multiline,this.options=_.extend({},defaults,t,e),this.flags=n.flags||"",this.wildcards=n.wildcards||{},this.assignments=n.assignments||{},this.lastIndex=n.lastIndex||0,this.lastRange=[0,0],this.compile(n)},compile:function(e){var t=[],n=[],r=[],i=["\\(","\\)",CAPTURE_PREFIX,INJECTION_PREFIX],s=this.wildcards,o=e||{},u;for(u in s)s.hasOwnProperty(u)&&(u[0]===CAPTURE_PREFIX&&(u=u.slice(1),r.push(u),i.push(u)),u[0]===INJECTION_PREFIX&&(u=u.slice(1),n.push(u),i.push(u)),t.push(u));this._captures=o.captures||[{path:"",name:""}],this.indices=o.indices||{path:{},name:{}},this.offset=o.offset||0,this._escaped=i,this._needle=new RegExp("\\\\("+i.join("|")+")|"+"\\(("+CAPTURE_PREFIX+"|"+INJECTION_PREFIX+")(\\w+(?:,\\w+)*):|"+"(\\((?!\\?:))|"+"("+CAPTURE_PREFIX+"|"+INJECTION_PREFIX+")("+(t.sort(byLength).join("|")||"$^")+")|"+"("+(r.join("|")||"$^")+")|"+"("+(n.join("|")||"$^")+")","g");var a=this._captures.length>1?this.source:this.build(this.source,this._captures),f=this.flags||(this.global?"g":"")+(this.ignoreCase?"i":"")+(this.multiline?"m":"");this._exp=new RegExp(a,f)},build:function(e,t,n){var r=_.isArray(e)?e:[e],i=this.wildcards,s=this._needle,o=this._escaped,u=this.indices.name,a=this.indices.path,f=n||[],l="",c=s.lastIndex=0,h,p,d,v,m,g,y,b,w,E,S,x;for(y=0;y<r.length;y++){b=r[y].hasOwnProperty("s")?r[y].s:r[y].hasOwnProperty("srcArr")?r[y].source:r[y];if(!b)return"";y>0&&(l+="|");while(v=s.exec(b))if(m=i[v[6]]||i[CAPTURE_PREFIX+v[7]]||i[INJECTION_PREFIX+v[8]]||(v[2]||v[4]?{s:findClosedReplacement(b.slice(s.lastIndex)),a:r[y].a||r[y].assign}:!1)){p=v[2]===CAPTURE_PREFIX||v[4]||v[5]===CAPTURE_PREFIX||typeof v[7]!="undefined",h=(v[3]||v[6]||v[7]||v[8]||"").split(","),f.indexOf(h[0])===-1?f.push(h[0]):this.error('"'+h[0]+'" includes itself. This would end up in infinity recursion loop!'),p&&(S=t.push(d={name:h[0],path:f.join(PATH_DELIMITER),aliases:_.rest(h)}),x=l.length,_.each(h,function(e){(u[e]||(u[e]=[])).push(S-1)}),(a[d.path]||(a[d.path]=[])).push(S-1)),g=this.build(m.s||m.source||m,t,f),l+=b.slice(c,v.index),c=v.index+v[0].length+(v[2]||v[4]?m.s.length+1:0),ASSIGNMENT_EXP.lastIndex=c,p&&(E=ASSIGNMENT_EXP.exec(b))&&(c+=E[0].length,d.a={force:2===E[1].length,path:E[2]});if(p&&this.options.captureRepetition&&(w=REPETITION_EXP.exec(b.slice(c)))){var T=0,N=1,C=2,k=3,L=4;d.r={capBound:[S,t.length],expBound:[x+4,x+g.length+4]};if(w[L]){var A=Exp.parse(PARENTHESIS,g,function(e){return e[1]||"(?:"}).join("");g="(?:"+g+")"+(w[N]!=="0"?"":w[C]?"?":"{0}")+"(?:"+w[L]+"(?:"+A+")"+"){"+(w[N]==="0"?0:w[N]-1)+w[C]+(w[k]?w[k]==="0"?0:w[k]-1:"")+"}"}else g="(?:"+g+")"+w[T];c+=w[T].length}l+=(p?"(":"(?:")+g+")",s.lastIndex=c,f.pop()}l+=b.slice(c)}return l.replace(new RegExp("\\\\("+o.join("|")+")","g"),"$1")},exec:function(e){var t,n;this._exp.lastIndex=this.lastIndex;if(t=this._exp.exec(e))this.lastIndex=this._exp.lastIndex,this.lastMatch=n=new Match(t,this),this.lastRange=n.lastRange;return n||null},test:function(e){return this._exp.test(e)},expand:function(e){return this.build(e,[],{})},error:function(e){if(DEBUG_MODE===!0)throw"Error in Expression /"+this.source+"/: "+e}};var getMapper=Exp.getMapper=function(e){var t,n,r={};return typeof e!="string"?e||_.identity:(n=parse(MARKER,e,function(e,t){r[t.length]=e[1]}),function(e){for(var t in r)n[t]=r[t]==="&"?e[0]:e.get?e.get(r[t]):e[r[t]];return n.join("")})},scan=Exp.scan=function(e,t,n){var r=[],i,s,o=getMapper(n);e.lastIndex=0;while(s=e.exec(t)){i=o.call(e,s,r);if(i===breaker)break;i!==skipper&&r.push(i);if(!e.global)break}return r},search=Exp.search=function(e,t,n){var r,i=getMapper(n);return scan(e,t,function(){return r=i.apply(this,arguments),r!==skipper?breaker:r}),r||null},parse=Exp.parse=function(e,t,n){var r=0,i=0,s=0,o,u=getMapper(n),a=/\n/g,f=scan(e,t,function(n,f){return o=t.slice(r,n.index),i+=count(a,o),n.i=++s,n.line=i,n.index!==r&&f.push(o),i+=count(a,n[0]||""),r=n.index+n[0].length,u.call(e,n,f)});return r<t.length&&f.push(t.slice(r)),f},replace=Exp.replace=function(e,t,n){return parse.apply(this,arguments).join("")},count=Exp.count=function(e,t,n){return scan.apply(this,arguments).length},breaker=Exp.breaker={},skipper=Exp.skipper={},esc=Exp.esc=function(e,t){return!_.isArray(e)||(e=e.join("")),e.replace(new RegExp("[\\-\\[\\]\\/\\{\\}\\(\\)\\*\\+\\?\\.\\\\\\^\\$\\|"+(t?"":"%#")+"]","g"),"\\$&")};_.each(["scan","search","parse","replace","count"],function(e){Exp.prototype[e]=function(){var t=[this];return aPush.apply(t,arguments),Exp[e].apply(this,t)}});var getCaptures=function(e){var t=e.split(SPLITTER);return _.chain(_.values(_.pick(this._exp.indices.path,t))).concat(_.values(_.pick(this._exp.indices.name,t))).flatten().union().map(function(e){var t=e-this._exp.offset,n=this._exp._captures[t].r,r=this._match[t];return n?Exp({source:sSlice.apply(this._exp._exp.source,n.expBound),captures:[{}].concat(aSlice.apply(this._exp._captures,n.capBound)),indices:this._exp.indices,assignments:this._exp.assignments,offset:n.capBound[0]-1,global:!0}).scan(r):r},this).value()},Match=Exp.Match=function(e,t){if(e instanceof Match)return Match;if(!(this instanceof Match))return new Match(e,t);this._wrapped=this._match=e,this._exp=t,this._getCaptures=_.memoize(getCaptures),_.extend(this,e),this.match=e[0],this.length=e.length,this.lastRange=t.lastRange,this.range=[e.index,t.lastIndex]},result=function(e,t){return e._chain?(e._wrapped=t,e):t};Match.prototype=_.extend(_([]),{capture:function(e){var t=_.isArray(e),n=this._getCaptures(t?e[0]:e);return result(this,t?n:n[0])},assignment:function(e){var t=this._assignments||(this._assignments=this._getAssignments());return e?resolvePath(e,t):t},get:function(e){return this.capture(e)||this.assignment(e)||this[e]},toString:function(){return this._match[0]},_getAssignments:function(){return _.reduce(this._match,function(e,t,n){var r=this._exp._captures[n],i,s,o;if(t===undefined||!r.a)return e;s=resolvePath(r.a.path,this._exp.assignments),s=s[t]||s;for(o in s)if(r.a.force||e[o]===undefined)e[o]=s[o];return e},{},this)}});var sSlice=String.prototype.slice,aSlice=Array.prototype.slice,aPush=Array.prototype.push,byLength=function(e,t){return t.length-e.length},findClosedReplacement=function(e){var t=1;return Exp.search(/\(|\)|\\\(|\\\)/g,e,function(n){return n[0]==="("&&t++,n[0]===")"&&t--,t===0?e.slice(0,n.index):skipper})},resolvePath=function(path,obj,delimitter){delimitter=delimitter||".",obj=obj||window;if(obj[path])return obj[path];path=(path+"").split(delimitter);try{return eval('(obj["'+path.join('"]["')+'"])')}catch(e){return undefined}};return Exp});
(function(t,e){if("object"==typeof exports){var n=require("underscore");module.exports=e(n)}else if("function"==typeof define&&define.amd)define(["underscore"],e);else{var i=t._;t.Exp=e(i)}})(this,function(_){"use strict";var escNativeExp=RegExp("[\\-\\[\\]\\/\\{\\}\\(\\)\\*\\+\\?\\.\\\\\\^\\$\\|]","g"),escAdvancedExp=RegExp("[\\-\\[\\]\\/\\{\\}\\(\\)\\*\\+\\?\\.\\\\\\^\\$\\|%#]","g"),esc=function(t,e){return _.isArray(t)&&(t=t.join("")),t.replace(e?escNativeExp:escAdvancedExp,"\\$&")},resolvePath=function(path,obj,delimitter){if(delimitter=delimitter||".",obj=obj||window,obj[path])return obj[path];path=(path+"").split(delimitter);try{return eval('(obj["'+path.join('"]["')+'"])')}catch(e){return void 0}},INJECTION_PREFIX="%",CAPTURE_PREFIX="#",ASSIGNMENT_PREFIX=">",PATH_DELIMITER=".",DELIMITER_ESC=esc(PATH_DELIMITER,!0),PATH="\\w+(?:"+DELIMITER_ESC+"(?:\\w+|\\[\\d+\\]))*",DEEP_PATH="\\w+(?:"+DELIMITER_ESC+"(?:\\w+|\\[\\d+\\]))+",ASSIGNMENT_EXP=RegExp("(^"+ASSIGNMENT_PREFIX+"{1,2})("+PATH+")"),REPETITION_EXP=/^[*+]|^\{(\d+)(,?)(\d*)(?:,([^\}]+))?\}/,MARKER=RegExp("\\$("+PATH+"|[\\d&])","g"),DEBUG_MODE=!0,SPLITTER=/,|\s+/,PARENTHESIS=/(\\\(|\(\?[:=!])|\((?:#\w+:)?/g,BREAK={},SKIP={},Collection=function(t){var e=function(t){this._wrapped=t||[]};return e.prototype=t([]),e.prototype.bind=function(e,n){var i=this._parent,s=this;return s[e]=t.isFunction(i[e])?function(){var t=arguments;return this.map(function(s){return i[e].apply(n||s,t)})}:t.isFunction(t[e])?function(){var i=arguments;return this.map(function(s){return t[e].apply(n||s,[s].concat(i))})}:function(){var i=arguments;return this.map(function(s){return t.isFunction(s[e])?s[e].apply(n||s,i):s[e]})},s[e]},e.prototype.add=function(e){this.push(t.isFunction(this._parent)?this._parent.apply(null,arguments):e)},e.extend=function(n,i){var s=i||{},r=s.fn||{},a=s.context,o=n.prototype||n,u=i.bind||t.functions(n),c=s.constructor||function(){},h=function(t){return this instanceof h?(e.apply(this,arguments),c.apply(this,arguments),void 0):new h(t)},p=t.extend(new e,r);return t.extend(h,s),p._parent=o,t.each(u,function(t){p.bind(t,a)}),h.prototype=p,h},e}(_),Exp=function(){var t=function(e,n){return e instanceof t?e:this instanceof t?(this.initialize(e,n),void 0):new t(e,n)};t.prototype={initialize:function(t,e){var n=e||t||{};this.source=t.source?""+t.source:t,this.global=t.global||n.global,this.ignoreCase=t.ignoreCase||n.ignoreCase,this.multiline=t.multiline||n.multiline,this.options=_.extend({},o,e,t),_.extend(this,_.pick(this.options,u)),this.flags=n.flags||"",this.wildcards=n.wildcards||{},this.assignments=n.assignments||{},this.zero(n.lastIndex),this.compile(n)},zero:function(t){return this.lastIndex=t||0,this.lastRange=[0,t||0],this.lastMatch=null,this},compile:function(t){var e,n=[],i=[],s=[],r=["\\(","\\)",CAPTURE_PREFIX,INJECTION_PREFIX],a=this.wildcards,o=t||{};for(e in a)a.hasOwnProperty(e)&&(e[0]===CAPTURE_PREFIX&&(e=e.slice(1),s.push(e),r.push(e)),e[0]===INJECTION_PREFIX&&(e=e.slice(1),i.push(e),r.push(e)),n.push(e));this._captures=o.captures||[{path:"",name:""}],this.indices=o.indices||{path:{},name:{},list:{}},this.offset=o.offset||0,this._escaped=r,this._needle=RegExp("\\\\("+r.join("|")+")|"+"\\(("+CAPTURE_PREFIX+"|"+INJECTION_PREFIX+")(\\w+(?:,\\w+)*):|"+"(\\((?!\\?:))|"+"("+CAPTURE_PREFIX+"|"+INJECTION_PREFIX+")("+(n.sort(l).join("|")||"$^")+")|"+"("+(s.join("|")||"$^")+")|"+"("+(i.join("|")||"$^")+")","g");var u=this._captures.length>1?this.source:this.build(this.source,this._captures),c=this.flags||(this.global?"g":"")+(this.ignoreCase?"i":"")+(this.multiline?"m":"");this._exp=RegExp(u,c)},build:function(e,n,i){var s,r,a,o,u,c,h,p,l,f,g,E,x=_.isArray(e)?e:[e],I=this.wildcards,m=this._needle,v=this._escaped,R=this.indices.name,P=this.indices.path,T=this.indices.list,A=i||[],y="",b=m.lastIndex=0;for(h=0;x.length>h;h++){if(p=x[h].hasOwnProperty("s")?x[h].s:x[h].hasOwnProperty("srcArr")?x[h].source:x[h],!p)return"";for(h>0&&(y+="|");o=m.exec(p);)if(u=I[o[6]]||I[CAPTURE_PREFIX+o[7]]||I[INJECTION_PREFIX+o[8]]||(o[2]||o[4]?{s:d(p.slice(m.lastIndex)),a:x[h].a||x[h].assign}:!1)){if(r=o[2]===CAPTURE_PREFIX||o[4]||o[5]===CAPTURE_PREFIX||o[7]!==void 0,s=(o[3]||o[6]||o[7]||o[8]||"").split(","),-1===A.indexOf(s[0])?A.push(s[0]):this.error('"'+s[0]+'" includes itself. This would end up in infinity recursion loop!'),r&&(g=n.push(a={name:s[0],path:A.join(PATH_DELIMITER),aliases:_.rest(s)}),E=y.length,_.each(s,function(t){(R[t]||(R[t]=[])).push(g-1)}),Object(P[a.path]||(P[a.path]=[])).push(g-1)),c=this.build(u.s||u.source||u,n,A),y+=p.slice(b,o.index),b=o.index+o[0].length+(o[2]||o[4]?u.s.length+1:0),r&&(f=p.slice(b).match(ASSIGNMENT_EXP))&&(b+=f[0].length,a.a={force:2===f[1].length,path:f[2]}),r&&this.options.enableLists&&(l=REPETITION_EXP.exec(p.slice(b)))){var C=0,S=1,M=2,N=3,w=4;if(a.r={capBound:[g,n.length],expBound:[E+4,E+c.length+4]},(T[a.path]||(T[a.path]=[])).push(g-1),l[w]){var O=t.parse(PARENTHESIS,c,function(t){return t.pseudo?t:t[1]||"(?:"}).join("");c="(?:"+c+")"+("0"!==l[S]?"":l[M]?"?":"{0}")+"(?:"+l[w]+"(?:"+O+")"+"){"+("0"===l[S]?0:l[S]-1)+l[M]+(l[N]?"0"===l[N]?0:l[N]-1:"")+"}"}else c="(?:"+c+")"+l[C];b+=l[C].length}y+=(r?"(":"(?:")+c+")",m.lastIndex=b,A.pop()}y+=p.slice(b)}return y.replace(RegExp("\\\\("+v.join("|")+")","g"),"$1")},exec:function(t){var e,n;return this._exp.lastIndex=this.lastIndex,(e=this._exp.exec(t))&&(this.lastIndex=this._exp.lastIndex,this.lastMatch=n=new Match(e,this),this.lastRange=n.range),n||null},test:function(t){return this._exp.test(t)},expand:function(t){return this.build(t,[],{})},error:function(t){if(DEBUG_MODE===!0)throw"Error in Expression /"+this.source+"/: "+t},subExp:function(e){var n=e-this.offset,i=this._captures[n];if(void 0!==i.r)return i.e||(i.e=new t({source:c.apply(this._exp.source,i.r.expBound),captures:[{}].concat(h.apply(this._captures,i.r.capBound)),indices:this.indices,assignments:this.assignments,offset:i.r.capBound[0]-1,global:!0})),this._captures[n].e},SKIP:SKIP,BREAK:BREAK};var e=t.scan=function(e,n,i){var s,r,a=f(i),o=e instanceof t?Match.Collection:_,u=[];for(_.isFunction(e.zero)?e.zero():e.lastIndex=0;(r=e.exec(n))&&(s=a.call(e,r,u),s!==BREAK)&&(s!==SKIP&&u.push(s),e.global););return _.extend(o(u),u,{length:u.length})},n=(t.search=function(t,n,i){var s,r=f(i);return e(t,n,function(){return s=r.apply(this,arguments),s!==SKIP?BREAK:s}),s||null},t.parse=function(t,n,s){var r,o=0,u=0,c=0,h=f(s),p=/\n/g,l=e(t,n,function(e,s){return r=n.slice(o,e.index),e.index!==o&&s.push(h.call(t,a({0:r,index:o,input:n,line:u},t),s)),u+=i(p,r),e.i=++c,e.line=u,u+=i(p,e[0]||""),o=e.index+e[0].length,h.call(t,e,s)});return n.length>o&&l.push(l[l.length]=n.slice(o)),l}),i=(t.replace=function(){return n.apply(this,arguments).join("")},t.count=function(){return e.apply(this,arguments).length}),s=function(t){return""+(t||this)[0]},r=function(t){var e=t||this;return e.pseudo?""+e:e},a=function(e,n){var i=_.extend([],{0:"",index:0,line:0,input:"",length:n&&n._captures&&n._captures.length||1,pseudo:!0,toString:s,toJSON:r},e||{});return n instanceof t?Match(i,n):i};t.esc=esc,_.each(["scan","search","parse","replace","count"],function(e){t.prototype[e]=function(){var n=[this];return p.apply(n,arguments),t[e].apply(this,n)}});var o={enableLists:!0,global:!1,ignoreCase:!1,multiline:!1},u=["source"],c=String.prototype.slice,h=Array.prototype.slice,p=Array.prototype.push,l=function(t,e){return e.length-t.length},f=t.getMapper=function(t){var e,i={};return"string"!=typeof t?t||_.identity:(e=n(MARKER,t,function(t,e){return t[1]?(i[e.length]=t[1],void 0):""+t}).value(),function(t){if(t.pseudo)return t[0];for(var n in i)e[n]="&"===i[n]?t[0]:t.get?t.get(i[n]):t[i[n]];return e.join("")})},d=function(e){var n=1;return t.search(/\(|\)|\\\(|\\\)/g,e,function(t){return"("===t[0]&&n++,")"===t[0]&&n--,0===n?e.slice(0,t.index):SKIP})};return t}(),Match=function(t){var e=function(e){var n=e.split(SPLITTER),i=this._exp,s=this,r=t.chain(i.indices.list).map(function(e,r){return t.chain(n).map(function(t){var n,a=t.indexOf(r);return n=0===a?t.slice(a+r.length+1):t,!n||0!==a&&-1!==t.indexOf(PATH_DELIMITER)||!i.subExp(e)?!1:s.getSubMatches(e).map(function(t){return t.cap([n])})}).compact().value()}).flatten().value();return t.chain(t.values(t.pick(i.indices.path,n))).concat(t.values(t.pick(i.indices.name,n))).flatten().union().map(function(t){return this.isList(t)?this.getSubMatches(t):this.getCapture(t)},this).concat(r).compact().union().value()},n=Exp.Match=function(i,s){return i instanceof n?n:this instanceof n?(this._wrapped=this._match=i,this._exp=s,this._getCaptures=t.memoize(e),this._subMatch={},t.extend(this,i),this.match=i[0],this.length=i.length,this.lastRange=s.lastRange,this.range=[i.index,s.lastIndex],this.pseudo=!!i.pseudo,this["&"]=i[0],this["`"]=this.input.slice(0,this.index),this["'"]=this.input.slice(s.lastIndex),void 0):new n(i,s)},i=function(t,e){return t._chain?(t._wrapped=e,t):e},s=n.prototype=t([]);return s.cap=s.capture=function(e){var n=t.isArray(e),s=this._getCaptures(n?e.join(","):e);return i(this,n?s:s[0])},s.atm=s.attachment=function(t){var e=this.getAssignments();return i(this,t?resolvePath(t,e):e)},s.assignment=s.atm,s.get=function(t){var e;return void 0!==(e=this.cap(t))?e:void 0!==(e=this.atm(t))?e:void 0!==(e="$"===t[0]?this[t.slice(1)]:this[t])?e:this[t]},s.toString=function(){return this._match[0]},s.toJSON=function(){return this.pseudo?""+this:{match:this._match,index:this.index}},s.getAssignments=function(){return this._assignments||(this._assignments=t.reduce(this._match,function(t,e,n){var i,s,r=this._exp._captures[n];if(void 0===e||!r.a)return t;i=resolvePath(r.a.path,this._exp.assignments),i=i[e]||i;for(s in i)(r.a.force||void 0===t[s])&&(t[s]=i[s]);return t},{},this)),i(this,this._assignments)},s.getOffset=function(t){return t-this._exp.offset},s.getSubMatches=function(t){return this._subMatch[t]||(this._subMatch[t]=this._exp.subExp(t).scan(this._match[this.getOffset(t)]))},s.getCapture=function(t){return this._match[this.getOffset(t)]},s.isList=function(t){return!!this._exp._captures[this.getOffset(t)].r},s.$="$",n.Collection=Collection.extend(n,{bind:["get","cap","capture","atm","attachment","assignment","getAssignments"]}),n}(_);return Exp.VERSION="0.2.1",Exp.Collection=Collection,Exp.Match=Match,Exp});
/*! exp.js - v0.1.1 - 2013-04-21
 * https://github.com/sbekoe/exp.js
 * Copyright (c) 2013 Simon Bekoe; Licensed MIT */
(function(e,t){if(typeof exports=="object"){var n=require("underscore");module.exports=t(n)}else if(typeof define=="function"&&define.amd)define(["underscore"],t);else{var r=e._;e.Exp=t(r)}})(this,function(_){"use strict";var escNativeExp=new RegExp("[\\-\\[\\]\\/\\{\\}\\(\\)\\*\\+\\?\\.\\\\\\^\\$\\|]","g"),escAdvancedExp=new RegExp("[\\-\\[\\]\\/\\{\\}\\(\\)\\*\\+\\?\\.\\\\\\^\\$\\|%#]","g"),esc=function(e,t){return _.isArray(e)&&(e=e.join("")),e.replace(t?escNativeExp:escAdvancedExp,"\\$&")},resolvePath=function(path,obj,delimitter){delimitter=delimitter||".",obj=obj||window;if(obj[path])return obj[path];path=(path+"").split(delimitter);try{return eval('(obj["'+path.join('"]["')+'"])')}catch(e){return undefined}},INJECTION_PREFIX="%",CAPTURE_PREFIX="#",ASSIGNMENT_PREFIX=">",PATH_DELIMITER=".",DELIMITER_ESC=esc(PATH_DELIMITER,!0),PATH="\\w+(?:"+DELIMITER_ESC+"(?:\\w+|\\[\\d+\\]))*",DEEP_PATH="\\w+(?:"+DELIMITER_ESC+"(?:\\w+|\\[\\d+\\]))+",ASSIGNMENT_EXP=new RegExp("("+ASSIGNMENT_PREFIX+"{1,2})("+PATH+")","g"),REPETITION_EXP=/^[*+]|^\{(\d+)(,?)(\d*)(?:,([^\}]+))?\}/,MARKER=new RegExp("\\$("+PATH+"|[\\d&])","g"),DEBUG_MODE=!0,SPLITTER=/,|\s+/,PARENTHESIS=/(\\\(|\(\?[:=!])|\((?:#\w+:)?/g,BREAK={},SKIP={},Collection=function(e){var t=function(e){this._wrapped=e||[]};return t.prototype=e([]),t.prototype.bind=function(t,n){var r=this._parent,i=this;return e.isFunction(r[t])?i[t]=function(){var e=arguments;return this.map(function(i){return r[t].apply(n||i,e)})}:e.isFunction(e[t])?i[t]=function(){var r=arguments;return this.map(function(i){return e[t].apply(n||i,[i].concat(r))})}:i[t]=function(){var r=arguments;return this.map(function(i){return e.isFunction(i[t])?i[t].apply(n||i,r):i[t]})},i[t]},t.prototype.add=function(t){this.push(e.isFunction(this._parent)?this._parent.apply(null,arguments):t)},t.extend=function(n,r){var i=r||{},s=i.fn||{},o=i.context,u=n.prototype||n,a=r.bind||e.functions(n),f=i.constructor||function(){},l=function(){t.apply(this,arguments),f.apply(this,arguments)},c=e.extend(new t,s);return e.extend(l,i),c._parent=u,e.each(a,function(e){c.bind(e,o)}),l.prototype=c,l},t}(_),Exp=function(){var e=function(t,n){if(t instanceof e)return t;if(!(this instanceof e))return new e(t,n);this.initialize(t,n)};e.prototype={initialize:function(e,t){var n=t||e||{};this.source=e.source?e.source.toString():e,this.global=e.global||n.global,this.ignoreCase=e.ignoreCase||n.ignoreCase,this.multiline=e.multiline||n.multiline,this.options=_.extend({},o,t,e),_.extend(this,_.pick(this.options,u)),this.flags=n.flags||"",this.wildcards=n.wildcards||{},this.assignments=n.assignments||{},this.lastIndex=n.lastIndex||0,this.lastRange=[0,0],this.compile(n)},compile:function(e){var t=[],n=[],r=[],i=["\\(","\\)",CAPTURE_PREFIX,INJECTION_PREFIX],s=this.wildcards,o=e||{},u;for(u in s)s.hasOwnProperty(u)&&(u[0]===CAPTURE_PREFIX&&(u=u.slice(1),r.push(u),i.push(u)),u[0]===INJECTION_PREFIX&&(u=u.slice(1),n.push(u),i.push(u)),t.push(u));this._captures=o.captures||[{path:"",name:""}],this.indices=o.indices||{path:{},name:{},list:{}},this.offset=o.offset||0,this._escaped=i,this._needle=new RegExp("\\\\("+i.join("|")+")|"+"\\(("+CAPTURE_PREFIX+"|"+INJECTION_PREFIX+")(\\w+(?:,\\w+)*):|"+"(\\((?!\\?:))|"+"("+CAPTURE_PREFIX+"|"+INJECTION_PREFIX+")("+(t.sort(c).join("|")||"$^")+")|"+"("+(r.join("|")||"$^")+")|"+"("+(n.join("|")||"$^")+")","g");var a=this._captures.length>1?this.source:this.build(this.source,this._captures),f=this.flags||(this.global?"g":"")+(this.ignoreCase?"i":"")+(this.multiline?"m":"");this._exp=new RegExp(a,f)},build:function(t,n,r){var i=_.isArray(t)?t:[t],s=this.wildcards,o=this._needle,u=this._escaped,a=this.indices.name,f=this.indices.path,l=this.indices.list,c=r||[],h="",d=o.lastIndex=0,v,m,g,y,b,w,E,S,x,T,N,C;for(E=0;E<i.length;E++){S=i[E].hasOwnProperty("s")?i[E].s:i[E].hasOwnProperty("srcArr")?i[E].source:i[E];if(!S)return"";E>0&&(h+="|");while(y=o.exec(S))if(b=s[y[6]]||s[CAPTURE_PREFIX+y[7]]||s[INJECTION_PREFIX+y[8]]||(y[2]||y[4]?{s:p(S.slice(o.lastIndex)),a:i[E].a||i[E].assign}:!1)){m=y[2]===CAPTURE_PREFIX||y[4]||y[5]===CAPTURE_PREFIX||typeof y[7]!="undefined",v=(y[3]||y[6]||y[7]||y[8]||"").split(","),c.indexOf(v[0])===-1?c.push(v[0]):this.error('"'+v[0]+'" includes itself. This would end up in infinity recursion loop!'),m&&(N=n.push(g={name:v[0],path:c.join(PATH_DELIMITER),aliases:_.rest(v)}),C=h.length,_.each(v,function(e){(a[e]||(a[e]=[])).push(N-1)}),(f[g.path]||(f[g.path]=[])).push(N-1)),w=this.build(b.s||b.source||b,n,c),h+=S.slice(d,y.index),d=y.index+y[0].length+(y[2]||y[4]?b.s.length+1:0),ASSIGNMENT_EXP.lastIndex=d,m&&(T=ASSIGNMENT_EXP.exec(S))&&(d+=T[0].length,g.a={force:2===T[1].length,path:T[2]});if(m&&this.options.captureRepetition&&(x=REPETITION_EXP.exec(S.slice(d)))){var k=0,L=1,A=2,O=3,M=4;g.r={capBound:[N,n.length],expBound:[C+4,C+w.length+4]},(l[g.path]||(l[g.path]=[])).push(N-1);if(x[M]){var D=e.parse(PARENTHESIS,w,function(e){return e[1]||"(?:"}).join("");w="(?:"+w+")"+(x[L]!=="0"?"":x[A]?"?":"{0}")+"(?:"+x[M]+"(?:"+D+")"+"){"+(x[L]==="0"?0:x[L]-1)+x[A]+(x[O]?x[O]==="0"?0:x[O]-1:"")+"}"}else w="(?:"+w+")"+x[k];d+=x[k].length}h+=(m?"(":"(?:")+w+")",o.lastIndex=d,c.pop()}h+=S.slice(d)}return h.replace(new RegExp("\\\\("+u.join("|")+")","g"),"$1")},exec:function(e){var t,n;this._exp.lastIndex=this.lastIndex;if(t=this._exp.exec(e))this.lastIndex=this._exp.lastIndex,this.lastMatch=n=new Match(t,this),this.lastRange=n.lastRange;return n||null},test:function(e){return this._exp.test(e)},expand:function(e){return this.build(e,[],{})},error:function(e){if(DEBUG_MODE===!0)throw"Error in Expression /"+this.source+"/: "+e},subExp:function(t){var n=t-this.offset,r=this._captures[n];if(r.r===undefined)return;return r.e||(r.e=new e({source:a.apply(this._exp.source,r.r.expBound),captures:[{}].concat(f.apply(this._captures,r.r.capBound)),indices:this.indices,assignments:this.assignments,offset:r.r.capBound[0]-1,global:!0})),this._captures[n].e},SKIP:SKIP,BREAK:BREAK};var t=e.scan=function(e,t,n){var r=[],i,s,o=h(n);e.lastIndex=0;while(s=e.exec(t)){i=o.call(e,s,r);if(i===BREAK)break;i!==SKIP&&r.push(i);if(!e.global)break}return _.extend(new Match.Collection(r),r,{length:r.length})},n=e.search=function(e,n,r){var i,s=h(r);return t(e,n,function(){return i=s.apply(this,arguments),i!==SKIP?BREAK:i}),i||null},r=e.parse=function(e,n,r){var i=0,o=0,u=0,a,f=h(r),l=/\n/g,c=t(e,n,function(t,r){return a=n.slice(i,t.index),o+=s(l,a),t.i=++u,t.line=o,t.index!==i&&r.push(a),o+=s(l,t[0]||""),i=t.index+t[0].length,f.call(e,t,r)});return i<n.length&&c.push(n.slice(i)),c},i=e.replace=function(e,t,n){return r.apply(this,arguments).join("")},s=e.count=function(e,n,r){return t.apply(this,arguments).length};e.esc=esc,_.each(["scan","search","parse","replace","count"],function(t){e.prototype[t]=function(){var n=[this];return l.apply(n,arguments),e[t].apply(this,n)}});var o={captureRepetition:!1,global:!1,ignoreCase:!1,multiline:!1},u=["source"],a=String.prototype.slice,f=Array.prototype.slice,l=Array.prototype.push,c=function(e,t){return t.length-e.length},h=e.getMapper=function(e){var t,n,i={};return typeof e!="string"?e||_.identity:(n=r(MARKER,e,function(e,t){i[t.length]=e[1]}).value(),function(e){for(var t in i)n[t]=i[t]==="&"?e[0]:e.get?e.get(i[t]):e[i[t]];return n.join("")})},p=function(t){var n=1;return e.search(/\(|\)|\\\(|\\\)/g,t,function(e){return e[0]==="("&&n++,e[0]===")"&&n--,n===0?t.slice(0,e.index):SKIP})};return e}(),Match=function(e){var t=function(t){var n=t.split(SPLITTER),r=[],i=this._exp.offset,s=this._exp;window.e||(window.e=[]);var o=e.chain(this._exp.indices.list).map(function(n,r){var o=t.indexOf(r),u;return u=o===0?t.slice(o+r.length+1):t,o!==0&&t.indexOf(PATH_DELIMITER)!==-1||!s.subExp(n)?!1:e.map(s.subExp(n).scan(this._match[n-i]),function(e){return e.cap([u])})},this).compact().flatten().value();return e.chain(e.values(e.pick(this._exp.indices.path,n))).concat(e.values(e.pick(this._exp.indices.name,n))).flatten().union().map(function(e){var t=e-this._exp.offset,n=this._exp._captures[t].r,r=this._match[t];return n?this._exp.subExp(e).scan(r):r},this).concat(o).union().value()},n=Exp.Match=function(r,i){if(r instanceof n)return n;if(!(this instanceof n))return new n(r,i);this._wrapped=this._match=r,this._exp=i,this._getCaptures=e.memoize(t),e.extend(this,r),this.match=r[0],this.length=r.length,this.lastRange=i.lastRange,this.range=[r.index,i.lastIndex],this["&"]=r[0],this["`"]=this.input.slice(0,this.index),this["'"]=this.input.slice(i.lastIndex)},r=function(e,t){return e._chain?(e._wrapped=t,e):t},i=n.prototype=e([]);return i.cap=i.capture=function(t){var n=e.isArray(t),i=this._getCaptures(n?t[0]:t);return r(this,n?i:i[0])},i.at=i.assignment=function(e){var t=this._assignments||(this._assignments=this._getAssignments());return e?resolvePath(e,t):t},i.get=function(e){return this.capture(e)||this.assignment(e)||this[e]},i.toString=function(){return this._match[0]},i._getAssignments=function(){return e.reduce(this._match,function(e,t,n){var r=this._exp._captures[n],i,s,o;if(t===undefined||!r.a)return e;s=resolvePath(r.a.path,this._exp.assignments),s=s[t]||s;for(o in s)if(r.a.force||e[o]===undefined)e[o]=s[o];return e},{},this)},i.$="$",n.Collection=Collection.extend(n,{bind:["get","cap","capture","assignment"]}),n}(_);return Exp.VERSION="0.1.1",Exp.Collection=Collection,Exp.Match=Match,Exp});